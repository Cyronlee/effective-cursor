---
title: "自动化测试框架"
---

# 自动化测试框架

> 让自动化测试为 AI 生成的代码验证正确性

## 核心理念

在 AI 辅助开发中，自动化测试工具的作用**并非被 AI 取代**，而是作为可靠的验证机制，融入 Agent 的反馈循环。

### 分工协作模型

```
┌─────────────────────────────────────────────────────────┐
│                  AI + 测试 协作闭环                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   AI Agent ──生成代码──> 测试套件 ──失败报告──> AI Agent │
│      │                                          │       │
│      │         (具体用例 + 预期 vs 实际)          │       │
│      └────────────── 针对性修复 ─────────────────┘       │
│                                                         │
│                   直至所有测试通过                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

| 角色 | 擅长的事 |
|-----|---------|
| **AI** | 快速生成功能代码、探索实现方案、重构逻辑 |
| **自动化测试** | 检查功能正确性、边界条件、回归问题、集成行为 |

这种分工比 "全交给 AI 自我验证" 更高效、更可靠：

- 测试提供**客观、可重复**的确定性反馈
- 避免 AI 的幻觉、自洽偏差或遗漏边缘案例
- 天然契合现有工程实践（CI/CD、TDD/BDD）

## JavaScript / TypeScript 测试

### Vitest（推荐）

现代、快速的测试框架，与 Vite 生态完美集成：

```bash
npm install -D vitest @testing-library/react @testing-library/jest-dom jsdom
```

**vitest.config.ts**

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: './src/test/setup.ts',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
    },
  },
});
```

**单元测试示例**

```typescript
// utils/formatDate.test.ts
import { describe, it, expect } from 'vitest';
import { formatDate } from './formatDate';

describe('formatDate', () => {
  it('should format date correctly', () => {
    const date = new Date('2024-01-15');
    expect(formatDate(date)).toBe('2024-01-15');
  });

  it('should handle invalid date', () => {
    expect(() => formatDate(new Date('invalid'))).toThrow();
  });
});
```

**组件测试示例**

```typescript
// components/Button.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { Button } from './Button';

describe('Button', () => {
  it('should render children', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('should call onClick when clicked', () => {
    const handleClick = vi.fn();
    render(<Button onClick={handleClick}>Click</Button>);
    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledOnce();
  });

  it('should be disabled when disabled prop is true', () => {
    render(<Button disabled>Click</Button>);
    expect(screen.getByRole('button')).toBeDisabled();
  });
});
```

### Jest（传统选择）

```bash
npm install -D jest @types/jest ts-jest @testing-library/react @testing-library/jest-dom
```

**jest.config.js**

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/test/setup.ts'],
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
};
```

## Python 测试

### PyTest（推荐）

```bash
pip install pytest pytest-cov pytest-asyncio
```

**pytest.ini**

```ini
[pytest]
testpaths = tests
python_files = test_*.py
python_functions = test_*
addopts = -v --cov=src --cov-report=term-missing
asyncio_mode = auto
```

**测试示例**

```python
# tests/test_user_service.py
import pytest
from src.services.user_service import UserService, UserNotFoundError

class TestUserService:
    @pytest.fixture
    def user_service(self):
        return UserService()

    def test_create_user_success(self, user_service):
        user = user_service.create_user(
            email="test@example.com",
            name="Test User"
        )
        assert user.email == "test@example.com"
        assert user.name == "Test User"
        assert user.id is not None

    def test_create_user_duplicate_email(self, user_service):
        user_service.create_user(email="test@example.com", name="User 1")
        with pytest.raises(ValueError, match="Email already exists"):
            user_service.create_user(email="test@example.com", name="User 2")

    def test_get_user_not_found(self, user_service):
        with pytest.raises(UserNotFoundError):
            user_service.get_user("non-existent-id")

    @pytest.mark.asyncio
    async def test_async_operation(self, user_service):
        result = await user_service.fetch_user_data("user-123")
        assert result is not None
```

## Java 测试

### JUnit 5 + Mockito

**pom.xml**

```xml
<dependencies>
  <dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>5.10.1</version>
    <scope>test</scope>
  </dependency>
  <dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-junit-jupiter</artifactId>
    <version>5.8.0</version>
    <scope>test</scope>
  </dependency>
  <dependency>
    <groupId>org.assertj</groupId>
    <artifactId>assertj-core</artifactId>
    <version>3.24.2</version>
    <scope>test</scope>
  </dependency>
</dependencies>
```

**测试示例**

```java
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void createUser_shouldReturnCreatedUser() {
        // Given
        CreateUserRequest request = new CreateUserRequest("test@example.com", "Test");
        User savedUser = new User("123", "test@example.com", "Test");
        when(userRepository.save(any(User.class))).thenReturn(savedUser);
        
        // When
        User result = userService.createUser(request);
        
        // Then
        assertThat(result.getId()).isEqualTo("123");
        assertThat(result.getEmail()).isEqualTo("test@example.com");
        verify(userRepository).save(any(User.class));
    }
    
    @Test
    void getUser_whenNotFound_shouldThrowException() {
        // Given
        when(userRepository.findById("999")).thenReturn(Optional.empty());
        
        // When/Then
        assertThatThrownBy(() -> userService.getUser("999"))
            .isInstanceOf(UserNotFoundException.class)
            .hasMessage("User not found: 999");
    }
}
```

## E2E 测试

### Playwright（推荐）

```bash
npm init playwright@latest
```

**playwright.config.ts**

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

**E2E 测试示例**

```typescript
// e2e/auth.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Authentication', () => {
  test('user can login successfully', async ({ page }) => {
    await page.goto('/login');
    
    await page.fill('[data-testid="email-input"]', 'user@example.com');
    await page.fill('[data-testid="password-input"]', 'password123');
    await page.click('[data-testid="login-button"]');
    
    await expect(page).toHaveURL('/dashboard');
    await expect(page.locator('[data-testid="welcome-message"]'))
      .toContainText('Welcome');
  });

  test('shows error for invalid credentials', async ({ page }) => {
    await page.goto('/login');
    
    await page.fill('[data-testid="email-input"]', 'wrong@example.com');
    await page.fill('[data-testid="password-input"]', 'wrongpassword');
    await page.click('[data-testid="login-button"]');
    
    await expect(page.locator('[data-testid="error-message"]'))
      .toContainText('Invalid credentials');
  });
});
```

## AI 协作最佳实践

### 1. 将测试失败详细反馈给 AI

测试失败时，提供完整的上下文：

```
测试失败报告：

测试用例：UserService.createUser should validate email format
期望：抛出 ValidationError
实际：未抛出错误，返回了 User 对象

相关代码：
- src/services/userService.ts:23-35

请修复 createUser 函数，添加邮箱格式验证。
```

### 2. 测试驱动 AI 开发（TDD）

先写测试，让 AI 实现：

```typescript
// 1. 人类先写测试
describe('calculateDiscount', () => {
  it('should return 0 for orders under $50', () => {
    expect(calculateDiscount(49)).toBe(0);
  });
  
  it('should return 10% for orders $50-$100', () => {
    expect(calculateDiscount(75)).toBe(7.5);
  });
  
  it('should return 20% for orders over $100', () => {
    expect(calculateDiscount(150)).toBe(30);
  });
});

// 2. 让 AI 根据测试实现函数
```

### 3. 覆盖率驱动

```bash
# 生成覆盖率报告
npm run test -- --coverage

# 让 AI 为未覆盖的分支写测试
```

## 测试框架速查表

| 语言 | 单元测试 | 组件/集成测试 | E2E 测试 |
|-----|---------|--------------|---------|
| TypeScript | Vitest / Jest | Testing Library | Playwright / Cypress |
| Python | PyTest | PyTest | Playwright / Selenium |
| Java | JUnit 5 | Spring Boot Test | Selenium |
| Go | testing | testify | chromedp |

## 下一步

测试框架配置完成后，接下来设置 [CI/CD 流程](./ci-cd)来自动化整个开发流程。

